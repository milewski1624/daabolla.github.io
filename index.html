<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Video Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="max-w-4xl mx-auto p-6">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white mb-3">üé¨ Universal Video Converter</h1>
            <p class="text-blue-100 text-lg">Convert videos to any format & resolution - 100% in your browser</p>
        </div>

        <div class="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 border border-white/20">
            <div class="mb-6">
                <label class="block text-white text-sm font-semibold mb-3">Select Video File</label>
                <div onclick="document.getElementById('fileInput').click()" 
                     class="border-2 border-dashed border-white/30 rounded-xl p-8 text-center cursor-pointer hover:border-white/60 hover:bg-white/5 transition-all">
                    <div class="text-6xl mb-3">üì§</div>
                    <p class="text-white font-medium mb-1" id="fileName">Click to upload video</p>
                    <p class="text-blue-200 text-sm" id="fileSize">Any video format supported (max 2GB recommended)</p>
                    <input type="file" id="fileInput" accept="video/*,audio/*,.mkv,.avi,.mov,.mp4,.webm,.flv,.wmv,.mpeg,.m4v" class="hidden">
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-white text-sm font-semibold mb-3">üé¨ Output Format</label>
                    <select id="formatSelect" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <optgroup label="Video Formats" class="bg-gray-800">
                            <option value="mp4">MP4</option>
                            <option value="avi">AVI</option>
                            <option value="mov">MOV</option>
                            <option value="mkv">MKV</option>
                            <option value="webm">WebM</option>
                            <option value="flv">FLV</option>
                            <option value="wmv">WMV</option>
                            <option value="mpeg">MPEG</option>
                        </optgroup>
                        <optgroup label="Audio Formats" class="bg-gray-800">
                            <option value="mp3">MP3</option>
                            <option value="wav">WAV</option>
                            <option value="aac">AAC</option>
                            <option value="ogg">OGG</option>
                            <option value="flac">FLAC</option>
                            <option value="m4a">M4A</option>
                        </optgroup>
                    </select>
                </div>

                <div>
                    <label class="block text-white text-sm font-semibold mb-3">‚öôÔ∏è Resolution</label>
                    <select id="resolutionSelect" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="original">Original</option>
                        <option value="3840x2160">4K (3840x2160)</option>
                        <option value="2560x1440">1440p (2560x1440)</option>
                        <option value="1920x1080">1080p (1920x1080)</option>
                        <option value="1280x720">720p (1280x720)</option>
                        <option value="854x480">480p (854x480)</option>
                        <option value="640x360">360p (640x360)</option>
                        <option value="426x240">240p (426x240)</option>
                    </select>
                </div>
            </div>

            <div id="fileSizeWarning" class="hidden bg-yellow-500/20 border border-yellow-400/50 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <div>
                        <p class="text-white font-semibold mb-1">Large File Warning</p>
                        <p class="text-yellow-100 text-sm">This file is very large (<span id="actualSize"></span>). Browser-based conversion works best with files under 2GB. For large files, conversion may fail or take a very long time. Consider using desktop software like HandBrake or FFmpeg for better results.</p>
                    </div>
                </div>
            </div>

            <div id="loadingStatus" class="hidden bg-blue-500/20 border border-blue-400/50 rounded-lg p-4 mb-6 flex items-center gap-3">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                <span class="text-white">Loading conversion engine...</span>
            </div>

            <button id="convertBtn" disabled class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-4 px-6 rounded-xl hover:from-blue-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg">
                üé¨ Convert Video
            </button>

            <div id="progressContainer" class="hidden mt-4">
                <div class="bg-white/10 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-400 to-purple-500 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-white text-center mt-2">Converting... 0%</p>
            </div>

            <div id="errorContainer" class="hidden mt-6 bg-red-500/20 border border-red-400/50 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">‚ùå</span>
                    <div>
                        <p class="text-white font-semibold mb-1">Conversion Error</p>
                        <p class="text-red-100 text-sm" id="errorMessage"></p>
                        <p class="text-red-100 text-sm mt-2">üí° <strong>Tip:</strong> If the file is large, try compressing it first or use desktop software like HandBrake or FFmpeg.</p>
                    </div>
                </div>
            </div>

            <div id="successContainer" class="hidden mt-6 bg-green-500/20 border border-green-400/50 rounded-lg p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-2xl">‚úÖ</span>
                    <span class="text-white font-semibold text-lg">Conversion Complete!</span>
                </div>
                
                <div id="previewContainer" class="mb-4"></div>

                <button id="downloadBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                    ‚¨áÔ∏è Download File
                </button>
            </div>
        </div>

        <div class="mt-6 bg-white/5 backdrop-blur rounded-xl p-6 border border-white/10">
            <h3 class="text-white font-semibold mb-3">‚öôÔ∏è Features & Limitations</h3>
            <ul class="text-blue-200 space-y-2 text-sm">
                <li>‚úì Supports all major video formats (MP4, AVI, MOV, MKV, WebM, FLV, WMV, MPEG)</li>
                <li>‚úì Extract audio in MP3, WAV, AAC, OGG, FLAC, M4A</li>
                <li>‚úì Multiple resolutions from 240p to 4K</li>
                <li>‚úì 100% client-side processing - your files never leave your device</li>
                <li>‚ö†Ô∏è Works best with files under 2GB (browser memory limitation)</li>
                <li>üí° For files over 2GB, consider using desktop tools like <a href="https://handbrake.fr/" target="_blank" class="underline hover:text-white">HandBrake</a> or <a href="https://ffmpeg.org/" target="_blank" class="underline hover:text-white">FFmpeg</a></li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { FFmpeg } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/esm/index.min.js';
        import { toBlobURL } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.min.js';

        let ffmpeg = null;
        let selectedFile = null;
        let convertedUrl = null;

        const audioFormats = ['mp3', 'wav', 'aac', 'ogg', 'flac', 'm4a'];
        const MAX_RECOMMENDED_SIZE = 2 * 1024 * 1024 * 1024; // 2GB

        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const formatSelect = document.getElementById('formatSelect');
        const resolutionSelect = document.getElementById('resolutionSelect');
        const loadingStatus = document.getElementById('loadingStatus');
        const convertBtn = document.getElementById('convertBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successContainer = document.getElementById('successContainer');
        const previewContainer = document.getElementById('previewContainer');
        const downloadBtn = document.getElementById('downloadBtn');
        const fileSizeWarning = document.getElementById('fileSizeWarning');
        const actualSize = document.getElementById('actualSize');

        async function loadFFmpeg() {
            if (ffmpeg) return;

            loadingStatus.classList.remove('hidden');
            
            try {
                ffmpeg = new FFmpeg();
                
                ffmpeg.on('log', ({ message }) => {
                    console.log(message);
                });
                
                ffmpeg.on('progress', ({ progress }) => {
                    const percent = Math.round(progress * 100);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = `Converting... ${percent}%`;
                });

                const baseURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm';
                await ffmpeg.load({
                    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm')
                });

                loadingStatus.classList.add('hidden');
                convertBtn.disabled = false;
            } catch (err) {
                showError('Failed to load FFmpeg engine. Please refresh the page and try again. Error: ' + err.message);
                loadingStatus.classList.add('hidden');
            }
        }

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                fileName.textContent = selectedFile.name;
                const sizeMB = (selectedFile.size / 1024 / 1024).toFixed(2);
                const sizeGB = (selectedFile.size / 1024 / 1024 / 1024).toFixed(2);
                
                if (selectedFile.size > 1024 * 1024 * 1024) {
                    fileSize.textContent = `${sizeGB} GB`;
                } else {
                    fileSize.textContent = `${sizeMB} MB`;
                }
                
                successContainer.classList.add('hidden');
                errorContainer.classList.add('hidden');
                
                // Show warning for large files
                if (selectedFile.size > MAX_RECOMMENDED_SIZE) {
                    fileSizeWarning.classList.remove('hidden');
                    actualSize.textContent = sizeGB + ' GB';
                } else {
                    fileSizeWarning.classList.add('hidden');
                }
                
                if (!ffmpeg) {
                    loadFFmpeg();
                }
            }
        });

        formatSelect.addEventListener('change', (e) => {
            const isAudio = audioFormats.includes(e.target.value);
            resolutionSelect.disabled = isAudio;
            resolutionSelect.style.opacity = isAudio ? '0.5' : '1';
        });

        convertBtn.addEventListener('click', async () => {
            if (!selectedFile || !ffmpeg) return;

            convertBtn.disabled = true;
            convertBtn.textContent = '‚è≥ Converting...';
            progressContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            successContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = 'Converting... 0%';

            try {
                const format = formatSelect.value;
                const resolution = resolutionSelect.value;

                // Check file size before processing
                if (selectedFile.size > MAX_RECOMMENDED_SIZE) {
                    const proceed = confirm(
                        `This file is ${(selectedFile.size / 1024 / 1024 / 1024).toFixed(2)} GB. ` +
                        `Large files may cause the browser to crash or run out of memory. ` +
                        `Do you want to proceed anyway?`
                    );
                    if (!proceed) {
                        convertBtn.disabled = false;
                        convertBtn.textContent = 'üé¨ Convert Video';
                        progressContainer.classList.add('hidden');
                        return;
                    }
                }

                const inputData = await selectedFile.arrayBuffer();
                await ffmpeg.writeFile('input', new Uint8Array(inputData));

                const outputFile = `output.${format}`;
                let command = ['-i', 'input'];

                if (resolution !== 'original' && !audioFormats.includes(format)) {
                    command.push('-vf', `scale=${resolution}`);
                }

                if (audioFormats.includes(format)) {
                    command.push('-vn');
                    if (format === 'mp3') {
                        command.push('-b:a', '192k');
                    } else if (format === 'aac' || format === 'm4a') {
                        command.push('-c:a', 'aac', '-b:a', '192k');
                    }
                } else {
                    if (format === 'mp4') {
                        command.push('-c:v', 'libx264', '-preset', 'medium', '-crf', '23');
                    } else if (format === 'webm') {
                        command.push('-c:v', 'libvpx-vp9', '-crf', '30');
                    }
                }

                command.push(outputFile);

                await ffmpeg.exec(command);

                const data = await ffmpeg.readFile(outputFile);
                const blob = new Blob([data.buffer], { 
                    type: audioFormats.includes(format) ? `audio/${format}` : `video/${format}` 
                });
                
                if (convertedUrl) {
                    URL.revokeObjectURL(convertedUrl);
                }
                convertedUrl = URL.createObjectURL(blob);

                previewContainer.innerHTML = '';
                if (audioFormats.includes(format)) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.className = 'w-full mb-4';
                    audio.src = convertedUrl;
                    previewContainer.appendChild(audio);
                } else {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.className = 'w-full rounded-lg mb-4';
                    video.src = convertedUrl;
                    previewContainer.appendChild(video);
                }

                successContainer.classList.remove('hidden');
                progressContainer.classList.add('hidden');

                await ffmpeg.deleteFile('input');
                await ffmpeg.deleteFile(outputFile);

            } catch (err) {
                let errorMsg = err.message;
                
                if (err.message.includes('out of memory') || err.message.includes('memory')) {
                    errorMsg = 'Browser ran out of memory. The file is too large to process in the browser. Try a smaller file or use desktop software.';
                } else if (selectedFile.size > MAX_RECOMMENDED_SIZE) {
                    errorMsg = `File too large (${(selectedFile.size / 1024 / 1024 / 1024).toFixed(2)} GB). Browser conversion is limited to ~2GB. Original error: ${err.message}`;
                }
                
                showError(errorMsg);
                progressContainer.classList.add('hidden');
            } finally {
                convertBtn.disabled = false;
                convertBtn.textContent = 'üé¨ Convert Video';
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (!convertedUrl) return;
            
            const a = document.createElement('a');
            a.href = convertedUrl;
            a.download = `converted.${formatSelect.value}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        function showError(msg) {
            errorMessage.textContent = msg;
            errorContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>
